name: Trello Integration

on:
  push:
    branches: [ master ]   # Ton repo utilise master
  pull_request:
    types: [ opened, closed ]

jobs:
  update-trello:
    runs-on: ubuntu-latest

    steps:
      # 1) RÃ©cupÃ©rer le message du commit et extraire l'ID de carte :
      - name: Extract Trello Card ID from commit message
        id: extract
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          # Format attendu : [TRELLO-xxxxxxx]
          CARD_ID=$(echo "$COMMIT_MSG" | grep -oP '(?<=\[TRELLO-)[^]]+(?=\])' || echo "")
          echo "card_id=$CARD_ID" >> $GITHUB_OUTPUT

      # 2) Ajouter un commentaire dans la carte Trello
      - name: Add comment to Trello card
        if: steps.extract.outputs.card_id != ''
        run: |
          curl -X POST "https://api.trello.com/1/cards/${{ steps.extract.outputs.card_id }}/actions/comments" \
            -d "key=${{ secrets.TRELLO_API_KEY }}" \
            -d "token=${{ secrets.TRELLO_TOKEN }}" \
            -d "text=Commit envoyÃ© par ${{ github.actor }}%0A${{ github.event.head_commit.message }}%0A${{ github.event.head_commit.url }}"

      # 3) DÃ©placer la carte vers EN REVUE (seulement sur master)
      - name: Move card to EN REVUE (master branch only)
        if: github.ref == 'refs/heads/master' && steps.extract.outputs.card_id != ''
        run: |
          curl -X PUT "https://api.trello.com/1/cards/${{ steps.extract.outputs.card_id }}" \
            -d "key=${{ secrets.TRELLO_API_KEY }}" \
            -d "token=${{ secrets.TRELLO_TOKEN }}" \
            -d "idList=${{ secrets.TRELLO_LIST_EN_REVUE }}"

      # 4) (Optionnel) Notification Slack
      - name: Send Slack notification
        if: github.ref == 'refs/heads/master' && steps.extract.outputs.card_id != ''
        uses: slackapi/slack-github-action@v1.24.0
        with:
          bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
          channel-id: C09R12J6N84
          slack-message: "ðŸŽ¯ La carte Trello <https://trello.com/c/${{ steps.extract.outputs.card_id }}|EN REVUE> vient d'Ãªtre dÃ©placÃ©e automatiquement !"
